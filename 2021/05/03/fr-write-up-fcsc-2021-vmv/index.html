<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>[FR] Write-up FCSC 2021 : VMV - redoste</title><link rel=stylesheet type=text/css href=/css/main.css></head><body><header><a href=https://redoste.xyz/><h2>redoste</h2></a><nav><ul><li><a href=/about/>About</a></li><li><a href=/projects/>Projects</a></li><li><a href=/posts/index.xml>RSS</a></li></ul></nav></header><hr><main><h2>[FR] Write-up FCSC 2021 : VMV</h2><span class=date>2021-05-03 18:00 +0200</span><hr><nav><ul><li><a href=/tags/ctf/>CTF</a></li><li><a href=/tags/fcsc/>FCSC</a></li><li><a href=/tags/fcsc-2021/>FCSC 2021</a></li></ul></nav><hr><h1 id=i---intro>I - Intro</h1><p><em>VMV</em> se compose d&rsquo;un simple executable ELF pour Linux x86-64. Il demande une chaine de 16 caractères de long en entrée et est censé nous indiquer s&rsquo;il s&rsquo;aggit du bon flag.</p><p>On peut essayer de l&rsquo;executer pour voir :</p><pre tabindex=0><code>$ ./vmv 0123456789ABCDEF
[fr] Ne quittez pas, un correspondant va prendre votre appel... [\fr]
* bruit de ventilateur de PC qui accélère *
[fr] Ne quittez pas, un correspondant va prendre votre appel... [\fr]
* htop indique 100% d&#39;usage du CPU *
[fr] Ne quittez pas, un correspondant va prendre votre appel... [\fr]
</code></pre><p>Bon il semble que comprendre ce qui se passe dynamiquement soit plutôt compromis.</p><h1 id=ii---reverse-engineering-du-binaire>II - Reverse engineering du binaire</h1><p>Comme le nom du challenge nous l&rsquo;a déjà suggéré, il s&rsquo;aggit probablement d&rsquo;une VM. Après avoir importé l&rsquo;executable dans Ghidra, on peut observer plusieurs parties intéressantes dans <code>main</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>FUNCTION_TABLE <span style=color:#f92672>=</span> (function_table_entry <span style=color:#f92672>**</span>)calloc(<span style=color:#ae81ff>8</span>,<span style=color:#ae81ff>0x20000</span>);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0x00adc52d</span>,ADD_weird);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0x0560729d</span>,MUL_weird);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0x48c5ccc6</span>,XOR);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0x542010a0</span>,AND_weird);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0xbdecfe55</span>,RET);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0x41f93b4b</span>,HALT_1);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0x5e64bb6c</span>,PUSH_imm);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0xed4e2cfb</span>,JMP);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0x180bc12d</span>,JE);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0x5a0f38fc</span>,JNE);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0x27497906</span>,HALT_2);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0xba1116a9</span>,ADD_imm);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0xfa83fa5e</span>,CALL);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0x818cd6b5</span>,HALT_with_exitcode);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0x8d67bae1</span>,READ_rom);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0xd1450d67</span>,WRITE_stdout);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0x8ea45b38</span>,DEC);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0xf00bb6c1</span>,INC);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0x5991ba22</span>,PUSH_reg);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0x43ae1f53</span>,MODULO);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0x8960888a</span>,POP_reg);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0x1f0a8e6f</span>,ADD_reg);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0x466a54d9</span>,HALT_3);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0xfb521a9c</span>,WRITE_ram);
</span></span><span style=display:flex><span>push_function_to_table(<span style=color:#ae81ff>0xc650f15d</span>,READ_ram);
</span></span></code></pre></div><p>Une table de fonctions semble être créée et chaque entrée de celle-ci est accompagnée d&rsquo;un opcode. Les fonctions correspondent donc à des instructions de la VM. Celles-ci sont plutôt faciles à identifier marlgré certaines, comme <code>MUL</code>, qui introduisent des maths bizares dans lesquelles je ne me suis pas aventuré.</p><p>En regardant attentivement ces fonctions, on remarque que lorsqu&rsquo;une instruction a besoin d&rsquo;un numéro de registre en opérande, celui-ci est xoré par <code>0xd77947b</code>. On en profitera pour construire la liste des instructions accompagnées de leurs paramètres</p><p>Plus loin on observe le chargement des 2 blocs de mémoires. Je les ai simplement appelées ROM et RAM, car l&rsquo;une d&rsquo;entre elles ne possède pas d&rsquo;instruction pour être écrite.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>ram_code <span style=color:#f92672>=</span> b64decode(RAM_CODE_B64,<span style=color:#ae81ff>0x3f10</span>);
</span></span><span style=display:flex><span>input_len <span style=color:#f92672>=</span> strlen(argv[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>ram_code_and_input <span style=color:#f92672>=</span> calloc(<span style=color:#ae81ff>1</span>,input_len <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x2f4c</span>);
</span></span><span style=display:flex><span>rom_code <span style=color:#f92672>=</span> b64decode(ROM_CODE_B64,<span style=color:#ae81ff>0x1328</span>);
</span></span><span style=display:flex><span>memcpy(ram_code_and_input,ram_code,<span style=color:#ae81ff>0x2f4c</span>);
</span></span><span style=display:flex><span>input_len <span style=color:#f92672>=</span> strlen(argv[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>memcpy(ram_code_and_input <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x2f4c</span>,argv[<span style=color:#ae81ff>1</span>],input_len);
</span></span><span style=display:flex><span>vm <span style=color:#f92672>=</span> vm_init(rom_code,ram_code_and_input);
</span></span></code></pre></div><p>On remarque qu&rsquo;avant d&rsquo;être passées à <code>vm_init</code>, la RAM et la ROM passent dans une fonction. En regardant la manière dont elles sont stockées dans le binaire, on se rend vite compte qu&rsquo;il s&rsquo;aggit d&rsquo;un simple encodage base64. Cela peut être confirmé en regardant les tailles passées en paramètre de chaque fonction. En effet, un groupe de 4 caractères base64 forment 3 octets une fois décodés : <code>(0x3f10 / 4) * 3 = 0x2f4c</code>.</p><p>Notre chaine d&rsquo;entrée est ajoutée à la fin de la RAM.</p><h1 id=iii---premier-deassemblage>III - Premier deassemblage</h1><p>Pour effectuer notre deassemblage de la ROM, j&rsquo;ai écrit un simple script Python (assez moche) :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> struct
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rom_pool <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>rom_index <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>labels <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>labels_index <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>assembly <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>r32</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>global</span> rom_index
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(rom_pool[rom_index:rom_index<span style=color:#f92672>+</span><span style=color:#ae81ff>4</span>]) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>4</span>:
</span></span><span style=display:flex><span>        rom_index <span style=color:#f92672>+=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    x <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#34;&lt;I&#34;</span>, rom_pool[rom_index:rom_index<span style=color:#f92672>+</span><span style=color:#ae81ff>4</span>])
</span></span><span style=display:flex><span>    rom_index <span style=color:#f92672>+=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> x[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_imm</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;0x</span><span style=color:#e6db74>%08X</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> (r32(),)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_rel</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>global</span> rom_index, labels, labels_index
</span></span><span style=display:flex><span>    x <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#34;&lt;i&#34;</span>, rom_pool[rom_index:rom_index<span style=color:#f92672>+</span><span style=color:#ae81ff>4</span>])[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>    rom_index <span style=color:#f92672>+=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>    new_pc <span style=color:#f92672>=</span> rom_index <span style=color:#f92672>+</span> (x <span style=color:#f92672>*</span> <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> new_pc <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> labels:
</span></span><span style=display:flex><span>        labels[new_pc] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;.l</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> labels_index
</span></span><span style=display:flex><span>        labels_index <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>%d</span><span style=color:#e6db74> </span><span style=color:#e6db74>%s</span><span style=color:#e6db74> @ 0x</span><span style=color:#e6db74>%08X</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> (x, labels[new_pc], new_pc)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_reg</span>():
</span></span><span style=display:flex><span>    specials <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>7</span>: <span style=color:#e6db74>&#34;pc&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>8</span>: <span style=color:#e6db74>&#34;pwi&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>9</span>: <span style=color:#e6db74>&#34;lr&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>12</span>: <span style=color:#e6db74>&#34;sp&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>22</span>: <span style=color:#e6db74>&#34;acc&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>25</span>: <span style=color:#e6db74>&#34;pri&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> (r32() <span style=color:#f92672>^</span> <span style=color:#ae81ff>0xd77947b</span>) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x3f</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> r <span style=color:#f92672>in</span> specials:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>_</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> (specials[r], r)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;r_</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> r
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>ADD_weird</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;ADD_weird s,s&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>MUL_weird</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;MUL_weird s,s&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>XOR</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;XOR s,s&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>AND_weird</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;AND_weird s,s&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>RET</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;RET&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>HALT_1</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;HALT_1&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>PUSH_imm</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;PUSH&#34;</span>, get_imm())
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>JMP</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;JMP&#34;</span>, get_rel())
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>JE</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;JE s,s&#34;</span>, get_rel())
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>JNE</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;JNE s,s&#34;</span>, get_rel())
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>HALT_2</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;HALT_2&#34;</span>, get_imm())
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>ADD_imm</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;pwi = acc &amp; ADD acc,&#34;</span>, get_imm())
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>CALL</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;CALL&#34;</span>, get_rel())
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>HALT_with_exitcode</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;HALT&#34;</span>, get_reg())
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>READ_rom</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;READ rom @pri(+4)&#34;</span>, get_reg())
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>WRITE_stdout</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;PRINT&#34;</span>, get_reg())
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>DEC</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;DEC&#34;</span>, get_reg())
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>INC</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;INC&#34;</span>, get_reg())
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>PUSH_reg</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;PUSH&#34;</span>, get_reg())
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>MODULO</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;MODULO s,&#34;</span>, get_reg())
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>POP_reg</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;POP&#34;</span>, get_reg())
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>ADD_reg</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;pwi = acc &amp; ADD acc,&#34;</span>, get_reg())
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>HALT_3</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;HALT_3&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>WRITE_ram</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;WRITE mem @pwi&#34;</span>, get_reg())
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>READ_ram</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;READ mem @pwi&#34;</span>, get_reg())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>instructions <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x00adc52d</span>: ADD_weird,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x0560729d</span>: MUL_weird,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x48c5ccc6</span>: XOR,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x542010a0</span>: AND_weird,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0xbdecfe55</span>: RET,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x41f93b4b</span>: HALT_1,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x5e64bb6c</span>: PUSH_imm,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0xed4e2cfb</span>: JMP,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x180bc12d</span>: JE,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x5a0f38fc</span>: JNE,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x27497906</span>: HALT_2,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0xba1116a9</span>: ADD_imm,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0xfa83fa5e</span>: CALL,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x818cd6b5</span>: HALT_with_exitcode,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x8d67bae1</span>: READ_rom,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0xd1450d67</span>: WRITE_stdout,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x8ea45b38</span>: DEC,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0xf00bb6c1</span>: INC,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x5991ba22</span>: PUSH_reg,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x43ae1f53</span>: MODULO,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x8960888a</span>: POP_reg,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x1f0a8e6f</span>: ADD_reg,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x466a54d9</span>: HALT_3,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0xfb521a9c</span>: WRITE_ram,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0xc650f15d</span>: READ_ram,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>], <span style=color:#e6db74>&#34;rb&#34;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>    rom_pool <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> rom_index <span style=color:#f92672>&lt;</span> len(rom_pool):
</span></span><span style=display:flex><span>    pc <span style=color:#f92672>=</span> rom_index
</span></span><span style=display:flex><span>    op_code <span style=color:#f92672>=</span> r32()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        assembly <span style=color:#f92672>+=</span> [(pc, instructions[op_code]())]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>KeyError</span>:
</span></span><span style=display:flex><span>        assembly <span style=color:#f92672>+=</span> [(pc, <span style=color:#e6db74>&#34;.word </span><span style=color:#e6db74>%08X</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> op_code)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> assembly:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> i[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>in</span> labels:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;           &#34;</span> <span style=color:#f92672>+</span> labels[i[<span style=color:#ae81ff>0</span>]])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> isinstance(i[<span style=color:#ae81ff>1</span>], str):
</span></span><span style=display:flex><span>        d <span style=color:#f92672>=</span> i[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        d <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34; &#34;</span><span style=color:#f92672>.</span>join(i[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>%08X</span><span style=color:#e6db74> : </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> (i[<span style=color:#ae81ff>0</span>], d))
</span></span></code></pre></div><p>On lance alors notre magnifique script en passant en argument un fichier qui contient notre ROM décodée.</p><p>C&rsquo;est alors qu&rsquo;on se rend compte de la réelle difficulté du challenge.</p><p>C&rsquo;est une autre VM.</p><p>En effet, on reconnait facilement le gros <code>switch</code> au milieu responsable de sauter à l&rsquo;endroit du code qui correspond à la bonne instruction :</p><pre tabindex=0><code>00000110 : PUSH r_0
00000118 : PUSH 0x952DB75F
00000120 : JE s,s 740 .l4 @ 0x00000CB8
00000128 : PUSH r_0
00000130 : PUSH 0x140C2CF8
00000138 : JE s,s 675 .l5 @ 0x00000BCC
00000140 : PUSH r_0
00000148 : PUSH 0x4517CC48
00000150 : JE s,s 774 .l6 @ 0x00000D70
00000158 : PUSH r_0
00000160 : PUSH 0xE80C7BE2
00000168 : JE s,s 350 .l7 @ 0x000006E8
           // ...
</code></pre><p>Et on reconnait aussi la partie responsable de lire un registre ou de lire un opcode :</p><pre tabindex=0><code>           .read_at_pc
00000DC0 : PUSH r_3
00000DC8 : PUSH 0x00000000
00000DD0 : ADD_weird s,s
00000DD4 : POP pwi_8
00000DDC : PUSH pwi_8
00000DE4 : READ mem @pwi pwi_8
00000DEC : PUSH pwi_8
00000DF4 : READ mem @pwi r_0
00000DFC : PUSH 0x00000001
00000E04 : ADD_weird s,s
00000E08 : POP r_5
00000E10 : POP pwi_8
00000E18 : WRITE mem @pwi r_5
00000E20 : RET

           .read_reg
00000E24 : PUSH 0x39EE8310
00000E2C : XOR s,s
00000E30 : PUSH 0x0000003F
00000E38 : AND_weird s,s
00000E3C : PUSH r_3
00000E44 : ADD_weird s,s
00000E48 : POP pwi_8
00000E50 : READ mem @pwi r_0
00000E58 : RET
</code></pre><p>On remarquera que les registres de la VM sont stockés dans la RAM et non dans des registres de l&rsquo;hote.</p><p>Une difference notable est la présence d&rsquo;une seconde clé pour l&rsquo;instruction <code>PRINT</code>. En effet, l&rsquo;immédiat présent après l&rsquo;instruction est xoré de la même manière que les numéros de registres.</p><p>J&rsquo;ai rapidement identifié les differentes instructions, qui sont les mêmes que la VM précedente, et j&rsquo;ai modifié le script avec les nouveaux opcodes et la nouvelle clé pour les registres.</p><p>En déassemblant ce qu&rsquo;on trouve au début de la RAM, on obtient encore une autre VM. Il semble que le problème doit être traité de manière plus automatique.</p><h1 id=iv---deassembleur-recurssif>IV - Deassembleur recurssif</h1><p>La première chose importante que j&rsquo;ai remarquée, c&rsquo;est que les codes des deux VMs étaient plutôt identiques. Les seules différences sont les opcodes et les clés de registres et de print. Il devrait être plutôt trivial d&rsquo;extraire ceux-ci à coup de manipulations moches de strings en Python.</p><p>La RAM étant plutôt conséquante (environ 12KB), j&rsquo;ai simplement supposé que les VMs sont les unes à la suite des autres et font la même taille que la première.</p><p>On peut alors écrire ce script Python (toujours d&rsquo;une aussi grande qualité):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> struct
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Dissassembly</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, rom, reg_key, print_key, opcodes):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>rom_pool <span style=color:#f92672>=</span> rom
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>reg_key <span style=color:#f92672>=</span> reg_key
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>print_key <span style=color:#f92672>=</span> print_key
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>opcodes <span style=color:#f92672>=</span> opcodes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>rom_index <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>labels <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>labels_index <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>assembly <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>specials <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>r32</span>(self):
</span></span><span style=display:flex><span>        x <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#34;&lt;I&#34;</span>, self<span style=color:#f92672>.</span>rom_pool[self<span style=color:#f92672>.</span>rom_index:self<span style=color:#f92672>.</span>rom_index<span style=color:#f92672>+</span><span style=color:#ae81ff>4</span>])
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>rom_index <span style=color:#f92672>+=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> x[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_imm</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;0x</span><span style=color:#e6db74>%08X</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> (self<span style=color:#f92672>.</span>r32(),)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_rel</span>(self):
</span></span><span style=display:flex><span>        x <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#34;&lt;i&#34;</span>, self<span style=color:#f92672>.</span>rom_pool[self<span style=color:#f92672>.</span>rom_index:self<span style=color:#f92672>.</span>rom_index<span style=color:#f92672>+</span><span style=color:#ae81ff>4</span>])[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>rom_index <span style=color:#f92672>+=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>        new_pc <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>rom_index <span style=color:#f92672>+</span> (x <span style=color:#f92672>*</span> <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> new_pc <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>labels:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>labels[new_pc] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;.l</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> self<span style=color:#f92672>.</span>labels_index
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>labels_index <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>%d</span><span style=color:#e6db74> </span><span style=color:#e6db74>%s</span><span style=color:#e6db74> @ 0x</span><span style=color:#e6db74>%08X</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> (x, self<span style=color:#f92672>.</span>labels[new_pc], new_pc)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_reg</span>(self):
</span></span><span style=display:flex><span>        r <span style=color:#f92672>=</span> (self<span style=color:#f92672>.</span>r32() <span style=color:#f92672>^</span> self<span style=color:#f92672>.</span>reg_key) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x3f</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> r <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>specials:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>_</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> (self<span style=color:#f92672>.</span>specials[r], r)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;r_</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> r
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>ADD</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;ADD s,s&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>MUL</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;MUL s,s&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>XOR</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;XOR s,s&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>AND</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;AND s,s&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>RET</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;RET&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>PUSH_imm</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;PUSH&#34;</span>, self<span style=color:#f92672>.</span>get_imm())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>JMP</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;JMP&#34;</span>, self<span style=color:#f92672>.</span>get_rel())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>JE</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;JE s,s&#34;</span>, self<span style=color:#f92672>.</span>get_rel())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>JNE</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;JNE s,s&#34;</span>, self<span style=color:#f92672>.</span>get_rel())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>ADD_imm</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;pwi = acc &amp; ADD acc,&#34;</span>, self<span style=color:#f92672>.</span>get_imm())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>CALL</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;CALL&#34;</span>, self<span style=color:#f92672>.</span>get_rel())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>HALT_reg</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;HALT&#34;</span>, self<span style=color:#f92672>.</span>get_reg())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>HALT_imm</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;HALT&#34;</span>, self<span style=color:#f92672>.</span>get_imm())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>READ_rom_reg</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;READ rom @pri(+4)&#34;</span>, self<span style=color:#f92672>.</span>get_reg())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>PRINT_reg</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;PRINT&#34;</span>, self<span style=color:#f92672>.</span>get_reg())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>PRINT_imm</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;PRINT&#34;</span>, chr((self<span style=color:#f92672>.</span>r32() <span style=color:#f92672>^</span> self<span style=color:#f92672>.</span>print_key) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xFF</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>DEC</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;DEC&#34;</span>, self<span style=color:#f92672>.</span>get_reg())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>INC</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;INC&#34;</span>, self<span style=color:#f92672>.</span>get_reg())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>PUSH_reg</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;PUSH&#34;</span>, self<span style=color:#f92672>.</span>get_reg())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>MODULO</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;MODULO s,&#34;</span>, self<span style=color:#f92672>.</span>get_reg())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>POP_reg</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;POP&#34;</span>, self<span style=color:#f92672>.</span>get_reg())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>ADD_reg</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;pwi = acc &amp; ADD acc,&#34;</span>, self<span style=color:#f92672>.</span>get_reg())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>WRITE_imm</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;WRITE mem @pwi&#34;</span>, self<span style=color:#f92672>.</span>get_imm())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>WRITE_reg</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;WRITE mem @pwi&#34;</span>, self<span style=color:#f92672>.</span>get_reg())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>READ_reg</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (<span style=color:#e6db74>&#34;READ mem @pwi&#34;</span>, self<span style=color:#f92672>.</span>get_reg())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_instructions</span>(self):
</span></span><span style=display:flex><span>        instructions <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> self<span style=color:#f92672>.</span>rom_index <span style=color:#f92672>&lt;</span> len(self<span style=color:#f92672>.</span>rom_pool):
</span></span><span style=display:flex><span>            pc <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>rom_index
</span></span><span style=display:flex><span>            opcode <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>r32()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                instructions <span style=color:#f92672>+=</span> [(pc, self<span style=color:#f92672>.</span>opcodes[opcode](self))]
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>KeyError</span>:
</span></span><span style=display:flex><span>                instructions <span style=color:#f92672>+=</span> [(pc, <span style=color:#e6db74>&#34;.word </span><span style=color:#e6db74>%08X</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> opcode)]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> instructions
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_dissassembly</span>(self):
</span></span><span style=display:flex><span>        instructions <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>get_instructions()
</span></span><span style=display:flex><span>        dissassembly <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> instructions:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> i[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>labels:
</span></span><span style=display:flex><span>                dissassembly <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;           &#34;</span> <span style=color:#f92672>+</span> self<span style=color:#f92672>.</span>labels[i[<span style=color:#ae81ff>0</span>]] <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> isinstance(i[<span style=color:#ae81ff>1</span>], str):
</span></span><span style=display:flex><span>                d <span style=color:#f92672>=</span> i[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                d <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34; &#34;</span><span style=color:#f92672>.</span>join(i[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>            dissassembly <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>%08X</span><span style=color:#e6db74> : </span><span style=color:#e6db74>%s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> (i[<span style=color:#ae81ff>0</span>], d)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> dissassembly
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>OPCODES_LIST <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>HALT_reg,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>DEC,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>RET,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>READ_reg,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>CALL,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>PRINT_reg,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>JMP,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>XOR,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>MUL,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>AND,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>INC,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>JE,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>WRITE_reg,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>ADD,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>PUSH_imm,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>READ_rom_reg,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>PUSH_reg,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>JNE,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>PRINT_imm,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>HALT_imm,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>ADD_imm,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>ADD_reg,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>POP_reg,
</span></span><span style=display:flex><span>        Dissassembly<span style=color:#f92672>.</span>MODULO,
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>build_opcodes_dict</span>(opcodes):
</span></span><span style=display:flex><span>    d <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(len(opcodes)):
</span></span><span style=display:flex><span>        d[opcodes[i]] <span style=color:#f92672>=</span> OPCODES_LIST[i]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> d
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Parser</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, dissassembly):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>dissassembly <span style=color:#f92672>=</span> dissassembly<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_reg_key</span>(self):
</span></span><span style=display:flex><span>        line <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>dissassembly[<span style=color:#ae81ff>507</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> line<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;00000E24 : PUSH &#34;</span>):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>Exception</span>(<span style=color:#e6db74>&#34;Invalid dissassembly : Unable to get reg_key&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> int(line[<span style=color:#ae81ff>16</span>:], <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_print_key</span>(self):
</span></span><span style=display:flex><span>        line <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>dissassembly[<span style=color:#ae81ff>32</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> line<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;000000E8 : PUSH &#34;</span>):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>Exception</span>(<span style=color:#e6db74>&#34;Invalid dissassembly : Unable to get print_key&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> int(line[<span style=color:#ae81ff>16</span>:], <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_opcodes</span>(self):
</span></span><span style=display:flex><span>        opcodes <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>39</span>, <span style=color:#ae81ff>109</span>, <span style=color:#ae81ff>3</span>):
</span></span><span style=display:flex><span>            line <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>dissassembly[i]
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#34; : PUSH &#34;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> line:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>Exception</span>(<span style=color:#e6db74>&#34;Invalid dissassembly : Unable to get opcodes at line </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> i)
</span></span><span style=display:flex><span>            opcodes <span style=color:#f92672>+=</span> [int(line[<span style=color:#ae81ff>16</span>:], <span style=color:#ae81ff>16</span>)]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> opcodes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>opcodes <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x952DB75F</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x140C2CF8</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x4517CC48</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0xE80C7BE2</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x950885B3</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0xF85712C3</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0xD708325C</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x01688047</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x54D4C1E6</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0xA9475B13</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x29CC50C7</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0xBF5E62BA</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x81761C59</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x2445BAFC</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x37D5991B</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0xEEF14B6E</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x3BD7549B</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x56AE0803</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x0B46465F</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x8032F32E</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x87AB3B02</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0xFB0A90EC</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0xEE68C600</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x5DCC45A4</span>,
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>reg_key <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x39EE8310</span>
</span></span><span style=display:flex><span>print_key <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x08929D1E</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>], <span style=color:#e6db74>&#34;rb&#34;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        f<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>        rom_pool <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>3676</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        d <span style=color:#f92672>=</span> Dissassembly(rom_pool, reg_key, print_key, build_opcodes_dict(opcodes))
</span></span><span style=display:flex><span>        dis <span style=color:#f92672>=</span> d<span style=color:#f92672>.</span>get_dissassembly()
</span></span><span style=display:flex><span>        p <span style=color:#f92672>=</span> Parser(dis)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            reg_key <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span>get_reg_key()
</span></span><span style=display:flex><span>            opcodes <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span>get_opcodes()
</span></span><span style=display:flex><span>            print_key <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span>get_print_key()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span>:
</span></span><span style=display:flex><span>            print(dis)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;New VM : reg :&#34;</span>, hex(reg_key))
</span></span></code></pre></div><p>J&rsquo;ai remarqué qu&rsquo;entre chaque VMs il y avait un entier dont j&rsquo;ignorais compeltement l&rsquo;utilité. En me repenchant dessus, je me suis rendu compte qu&rsquo;il s&rsquo;aggissait simplement de la taille de la VM à venir. Comme toutes les VMs sont de la même taille, je l&rsquo;ai simplement ignoré.</p><p>En utilisant donc ce script, on obtient le code de la dernière VM qui implémente la vérification finale :</p><pre tabindex=0><code>00000000 : PUSH 0x00000000
00000008 : POP r_16
00000010 : READ rom @pri(+4) r_14
00000018 : PUSH 0x00000001
00000020 : PUSH r_14
00000028 : PUSH 0x117052C0
00000030 : MUL s,s
00000034 : JNE s,s 2 .l1 @ 0x00000044
0000003C : INC r_16
           .l1
00000044 : READ rom @pri(+4) r_14
0000004C : PUSH r_14
00000054 : PUSH 0x000077F3
0000005C : POP r_15
00000064 : MODULO s, r_15
0000006C : PUSH 0x00004926
00000074 : JE s,s 4 .l2 @ 0x0000008C
0000007C : PUSH 0x00000000
00000084 : POP r_16
           .l2
0000008C : PUSH r_14
00000094 : PUSH 0x00007C49
0000009C : POP r_15
000000A4 : MODULO s, r_15
000000AC : PUSH 0x00003159
000000B4 : JE s,s 4 .l3 @ 0x000000CC
000000BC : PUSH 0x00000000
000000C4 : POP r_16
           .l3
000000CC : READ rom @pri(+4) r_14
000000D4 : PUSH 0x00000001
000000DC : PUSH r_14
000000E4 : PUSH 0x278BCE9D
000000EC : MUL s,s
000000F0 : JNE s,s 2 .l4 @ 0x00000100
000000F8 : INC r_16
           .l4
00000100 : READ rom @pri(+4) r_14
00000108 : PUSH r_14
00000110 : PUSH 0x000077F3
00000118 : POP r_15
00000120 : MODULO s, r_15
00000128 : PUSH 0x000028B2
00000130 : JE s,s 4 .l5 @ 0x00000148
00000138 : PUSH 0x00000000
00000140 : POP r_16
           .l5
00000148 : PUSH r_14
00000150 : PUSH 0x00007C49
00000158 : POP r_15
00000160 : MODULO s, r_15
00000168 : PUSH 0x000044A9
00000170 : JE s,s 4 .l6 @ 0x00000188
00000178 : PUSH 0x00000000
00000180 : POP r_16
           .l6
00000188 : PUSH r_16
00000190 : PUSH 0x00000002
00000198 : JE s,s 2 .l7 @ 0x000001A8
000001A0 : JMP 110 .l8 @ 0x00000360
           .l7
000001A8 : PRINT &#34;Congratulations, you won. Validate with FCSC{&lt;input&gt;}\n&#34;
00000358 : HALT 0x00000000
           .l8
00000360 : PRINT &#34;Noooooo, damn you lost!\n&#34;
00000420 : HALT 0x00000001
</code></pre><p>Il y a 4 <code>READ rom @pri(+4)</code>, or notre entrée fait 16 octets de long et chaque <code>READ</code> en lis 4. On peut donc supposer que notre entrée est lue régulièrement dans r14.</p><p>Oui, l&rsquo;entrée est supposée avoir été concaténée avec la RAM et non la ROM, mais on va mettre ca sur le dos du fait que je ne suis pas allé dans le détail lors de l&rsquo;analyse de la première sous-VM.</p><p>Il faut donc que les 4 groupes de 4 octets qui composent notre flag respectent les conditions suivantes :</p><pre tabindex=0><code>FLAG[0] * 0x117052C0 = 1
FLAG[1] % 0x000077F3 = 0x00004926
FLAG[1] % 0x00007C49 = 0x00003159
FLAG[2] * 0x278BCE9D = 1
FLAG[3] % 0x000077F3 = 0x000028B2
FLAG[3] % 0x00007C49 = 0x000044A9
</code></pre><h1 id=v---conclusion>V - Conclusion</h1><p>Cela ne semble pas très complexe à brute-force, mais j&rsquo;ai rencontré quelques problèmes, notament sur la multiplication. En effet la VM n&rsquo;implemente pas une &ldquo;vraie&rdquo; multiplication. J&rsquo;ai essayé de reimplémenter la chose en me basant sur la decompilation de Ghidra mais cela n&rsquo;a pas fonctionné : il n&rsquo;y avait aucune solution.</p><p>J&rsquo;ai donc fini par opter pour une solution plus radicale, j&rsquo;ai simplement et bêtement copié l&rsquo;assembleur x86 du binaire dans mon programme de brute-force :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdint.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>uint32_t</span> <span style=color:#a6e22e>mul_weird</span>(<span style=color:#66d9ef>uint64_t</span> a, <span style=color:#66d9ef>uint64_t</span> b);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>uint32_t</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x20202020</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0x7F7F7F7F</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span> m <span style=color:#f92672>=</span> mul_weird(i, <span style=color:#ae81ff>0x117052C0</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (m <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>      printf(<span style=color:#e6db74>&#34;%08X</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, i);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  printf(<span style=color:#e6db74>&#34;==</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>uint32_t</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x20202020</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0x7F7F7F7F</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> <span style=color:#66d9ef>long</span> m <span style=color:#f92672>=</span> i <span style=color:#f92672>%</span> <span style=color:#ae81ff>0x000077F3</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> <span style=color:#66d9ef>long</span> n <span style=color:#f92672>=</span> i <span style=color:#f92672>%</span> <span style=color:#ae81ff>0x00007C49</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (m <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x00004926</span> <span style=color:#f92672>&amp;&amp;</span> n <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x00003159</span>)
</span></span><span style=display:flex><span>      printf(<span style=color:#e6db74>&#34;%08X</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, i);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  printf(<span style=color:#e6db74>&#34;==</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>uint32_t</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x20202020</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0x7F7F7F7F</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span> m <span style=color:#f92672>=</span> mul_weird(i, <span style=color:#ae81ff>0x278BCE9D</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (m <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>      printf(<span style=color:#e6db74>&#34;%08X</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, i);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  printf(<span style=color:#e6db74>&#34;==</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>uint32_t</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x20202020</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0x7F7F7F7F</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> <span style=color:#66d9ef>long</span> m <span style=color:#f92672>=</span> i <span style=color:#f92672>%</span> <span style=color:#ae81ff>0x000077F3</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> <span style=color:#66d9ef>long</span> n <span style=color:#f92672>=</span> i <span style=color:#f92672>%</span> <span style=color:#ae81ff>0x00007C49</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (m <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x000028B2</span> <span style=color:#f92672>&amp;&amp;</span> n <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x000044A9</span>)
</span></span><span style=display:flex><span>      printf(<span style=color:#e6db74>&#34;%08X</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, i);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#a6e22e>bits</span> <span style=color:#ae81ff>64</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>global</span> <span style=color:#66d9ef>mul_weird</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mul_weird:
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mov</span> <span style=color:#66d9ef>rdx</span>, <span style=color:#66d9ef>rsi</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mov</span> <span style=color:#66d9ef>rax</span>, <span style=color:#66d9ef>rdi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>; Partie copiée du binaire d&#39;origine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>MOV</span>        <span style=color:#66d9ef>RCX</span>,<span style=color:#66d9ef>RDX</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>IMUL</span>       <span style=color:#66d9ef>RCX</span>,<span style=color:#66d9ef>RAX</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>MOV</span>        <span style=color:#66d9ef>RDX</span>,<span style=color:#ae81ff>0x200000005</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>MOV</span>        <span style=color:#66d9ef>RAX</span>,<span style=color:#66d9ef>RCX</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>MUL</span>        <span style=color:#66d9ef>RDX</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>MOV</span>        <span style=color:#66d9ef>RAX</span>,<span style=color:#66d9ef>RCX</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>SUB</span>        <span style=color:#66d9ef>RAX</span>,<span style=color:#66d9ef>RDX</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>SHR</span>        <span style=color:#66d9ef>RAX</span>,<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ADD</span>        <span style=color:#66d9ef>RAX</span>,<span style=color:#66d9ef>RDX</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>SHR</span>        <span style=color:#66d9ef>RAX</span>,<span style=color:#ae81ff>0x1e</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>MOV</span>        <span style=color:#66d9ef>RDX</span>,<span style=color:#66d9ef>RAX</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>SHL</span>        <span style=color:#66d9ef>RDX</span>,<span style=color:#ae81ff>0x1f</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>SUB</span>        <span style=color:#66d9ef>RDX</span>,<span style=color:#66d9ef>RAX</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>MOV</span>        <span style=color:#66d9ef>RAX</span>,<span style=color:#66d9ef>RCX</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>SUB</span>        <span style=color:#66d9ef>RAX</span>,<span style=color:#66d9ef>RDX</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; MOV        RDX,qword ptr [RBP + local_20]
</span></span></span><span style=display:flex><span><span style=color:#75715e>; MOV        RCX,qword ptr [RDX]
</span></span></span><span style=display:flex><span><span style=color:#75715e>; MOV        RDX,qword ptr [RBP + local_20]
</span></span></span><span style=display:flex><span><span style=color:#75715e>; MOV        EDX,dword ptr [RDX + 0x38]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>MOVSXD</span>     <span style=color:#66d9ef>RDX</span>,<span style=color:#66d9ef>EDX</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>SHL</span>        <span style=color:#66d9ef>RDX</span>,<span style=color:#ae81ff>0x2</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ADD</span>        <span style=color:#66d9ef>RDX</span>,<span style=color:#66d9ef>RCX</span>
</span></span><span style=display:flex><span><span style=color:#75715e>; MOV        dword ptr [RDX],EAX
</span></span></span><span style=display:flex><span><span style=color:#75715e>; NOP
</span></span></span><span style=display:flex><span><span style=color:#75715e>; POP        RBP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>RET</span>
</span></span></code></pre></div><p>Cela prend environ une dizaine de secondes sur ma machine. On obtient alors les 4 ints qui composent le flag :</p><pre tabindex=0><code>654E3377
==
30546445
6A904C90
==
65444F67
==
37F787E8
72337033
</code></pre><p>En éliminant les résultats qui possèdent des caractères non imprimables et en rétablissant l&rsquo;endianness, on obtient :</p><pre tabindex=0><code>FCSC{w3NeEdT0gODe3p3r}
</code></pre></main><hr><footer>© 2020 - 2022 redoste - <a href=https://creativecommons.org/licenses/by/4.0/>CC-BY-4.0</a></footer></body></html>