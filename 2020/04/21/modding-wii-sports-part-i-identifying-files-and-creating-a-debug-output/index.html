<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Modding Wii Sports : Part I : Identifying files and creating a debug output - redoste</title>
<link rel=stylesheet type=text/css href=/css/main.css></head><body><header><a href=/><h2>redoste</h2></a><nav><ul><li><a href=/about/>About</a></li><li><a href=/projects/>Projects</a></li><li><a href=/posts/index.xml>RSS</a></li></ul></nav></header><hr><main><h2>Modding Wii Sports : Part I : Identifying files and creating a debug output</h2><span class=date>2020-04-21 16:00 +0200</span><hr><nav><ul><li><a href=/tags/wii/>Wii</a></li><li><a href=/tags/wii-modding/>Wii Modding</a></li><li><a href=/tags/wii-sports/>Wii Sports</a></li></ul></nav><hr><p>A few months ago I saw someone playing <em>Wii Sports</em> doing some Golf. This reminded me I always wanted to create custom golf tracks. After a little bit of search, I found out that nobody really did it. <a href=https://www.reddit.com/r/WiiHacks/comments/ec5829/looking_for_wii_sports_golf_mods/>Some people were asking if someone did it</a> and they were a few attempts on <em>Wii Sport Resort</em> (<a href=https://youtu.be/aQiqRE5HbYI>here</a>, <a href=https://www.reddit.com/r/WiiHacks/comments/f2lq45/fully_custom_wii_sports_golf_course/>here</a> or <a href=https://www.reddit.com/r/WiiHacks/comments/f0kt3z/custom_wii_sports_golf_course_poc/>here</a>) but I found no real public source code or walkthrough of how to do your own custom golf track on the original <em>Wii Sports</em>.</p><p>After struggling for multiples weeks now I will show you my current (slow) progress and I hope I will be able to continue this series of blog posts up until a complete usable mod. The best would be an easy to use tool that allow a conversion of any 3D models into a golf course and a user interface on the Wii that allow loading custom tracks from the SD card. For the moment I&rsquo;m not skilled enough nor I have enough time but maybe writing blog posts will encourage me to continue&mldr;</p><h1 id=i---identifying-existing-files>I - Identifying existing files</h1><p>The first easy step was to rip the original disc. I own an original <em>Wii Sports</em> European disc, it is the second revision that have some bug patched. I used <a href=https://sourceforge.net/projects/usbloadergx/>USBLoaderGX</a>, it&rsquo;s a backup loader that allow to copy discs to an USB drive. It produces a WBFS file, it is a custom file format that only contain useful part of the ISO, by removing all the padding an image can shrink from 4GiB to a few hundreds of MiB (it, of course, depends of the game).</p><p>To extract and rebuild WBFS images I used the <a href=https://wit.wiimm.de/><em>Wiimms ISO Tools</em> suite</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#75715e># We can easily extract the content of the original image</span>
</span></span><span style=display:flex><span>$ wit X RSPP01.wbfs RSPP01/
</span></span><span style=display:flex><span>*****  wit: Wiimms ISO Tool v3.02a r0 x86_64 - Dirk Clemens - 2020-03-07  *****
</span></span><span style=display:flex><span>wit: EXTRACT 1/1 WBFS:RSPP01.wbfs/#0 -&gt; RSPP01/
</span></span><span style=display:flex><span>$ <span style=color:#75715e># And rebuild the modded one after some work</span>
</span></span><span style=display:flex><span>$ wit CP RSPP01.modded/ RSPP01.modded.wbfs
</span></span><span style=display:flex><span>*****  wit: Wiimms ISO Tool v3.02a r0 x86_64 - Dirk Clemens - 2020-03-07  *****
</span></span><span style=display:flex><span>* COPY/SCRUB 1/1 FST:RSPP01.modded/ -&gt; WBFS:RSPP01.modded.wbfs
</span></span></code></pre></div><p>After a little bit of search, we can identify two important things:</p><ul><li>The <code>sys/main.dol</code> file, it is the main game binary in the <a href=https://wiibrew.org/wiki/DOL>DOL format</a> (the executable format for the Wii and the GameCube)</li><li>The <code>files/Stage/RPGolScene/</code> folder, it contains a file per golf track. The name of most of the file is in the form <code>glf_course_fcX.carc</code> where <code>fc</code> is for <em>Family Computer</em> or <em>Famicom</em> (the Japanese version of the NES) and the number identify the number of the track it corresponds to in the <a href=https://en.wikipedia.org/wiki/Golf_(1984_video_game)>1984 <em>Golf</em> NES game</a>.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>total 17M
</span></span><span style=display:flex><span>1,8M glf_course_E3.carc
</span></span><span style=display:flex><span>258K glf_course_angle.carc
</span></span><span style=display:flex><span>1,6M glf_course_fc1.carc
</span></span><span style=display:flex><span>1,3M glf_course_fc11.carc
</span></span><span style=display:flex><span>1,1M glf_course_fc12.carc
</span></span><span style=display:flex><span>1,8M glf_course_fc13.carc
</span></span><span style=display:flex><span>1,3M glf_course_fc14.carc
</span></span><span style=display:flex><span>1,8M glf_course_fc16.carc
</span></span><span style=display:flex><span>367K glf_course_fc18.carc
</span></span><span style=display:flex><span>1,1M glf_course_fc3.carc
</span></span><span style=display:flex><span>1,6M glf_course_fc5.carc
</span></span><span style=display:flex><span>1,9M glf_course_fc8.carc
</span></span><span style=display:flex><span>1,3M glf_course_fc9.carc
</span></span><span style=display:flex><span>212K glf_course_survey.carc
</span></span></code></pre></div><p>These <code>carc</code> files are in fact <a href=http://wiki.tockdom.com/wiki/Yaz0><em>Yaz0</em></a> compressed <a href=http://wiki.tockdom.com/wiki/U8><em>U8</em></a> archives. Another <em>Wiimms</em> tool suite can be used to extract these files: the <a href=https://szs.wiimm.de/><em>Wiimms SZS Toolset</em></a>.</p><p>Here is the content of <code>glf_course_fc1.carc</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ wszst LL glf_course_fc1.carc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>* Files of YAZ0.U8:glf_course_fc1.carc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>size/dec  magic file or directory
</span></span><span style=display:flex><span>-------------------------------------------------------------------------------
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>687202</span>  ...&lt;  glf_course_fc1.kcl
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>10600</span>  PMPF  glf_course_fc1.pmp
</span></span><span style=display:flex><span>       -  -     G3D/
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>999424</span>  bres  G3D/glf_course_fc1.brres
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>179712</span>  bres  G3D/glf_map_fc1.brres
</span></span><span style=display:flex><span>       -  -     glf_scene_fc1/
</span></span><span style=display:flex><span>     <span style=color:#ae81ff>164</span>  PBLM  glf_scene_fc1/glf_scene_fc1.pblm
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>1352</span>  LGHT  glf_scene_fc1/glf_scene_fc1.plight
</span></span><span style=display:flex><span>     <span style=color:#ae81ff>408</span>  LMAP  glf_scene_fc1/glf_scene_fc1.plmap
</span></span></code></pre></div><h2 id=1---the-glf_course_fc1kcl-file>1 - The <code>glf_course_fc1.kcl</code> file</h2><p><a href=http://wiki.tockdom.com/wiki/KCL>The <code>kcl</code> file format</a> is the same used in the <em>Mario Kart Wii</em> game to describe the collision of a the track. We can suppose this one also describe the collision of the golf track. Using <code>wkclt</code> from the <em>Wiimms SZS Toolset</em>, we can convert the <code>kcl</code> into a simple <a href=https://en.wikipedia.org/wiki/Wavefront_.obj_file>Wavefront <code>obj</code> file</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ wkclt DEC glf_course_fc1.kcl
</span></span><span style=display:flex><span>DECODE KCL:glf_course_fc1.kcl -&gt; KCLTXT:./glf_course_fc1.obj
</span></span><span style=display:flex><span>* CHECK KCL:glf_course_fc1.kcl
</span></span><span style=display:flex><span>    - HINT: <span style=color:#ae81ff>1</span> of <span style=color:#ae81ff>8398</span> drivable triangles is face down <span style=color:#f92672>=</span>&gt; --kcl<span style=color:#f92672>=</span>RM-FACEDOWN
</span></span><span style=display:flex><span>    - HINT: <span style=color:#ae81ff>1</span> of <span style=color:#ae81ff>8398</span> drivable triangles is face down <span style=color:#f92672>(</span>&gt;30°<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; No warnings and <span style=color:#ae81ff>2</span> hints <span style=color:#66d9ef>for</span> KCL:glf_course_fc1.kcl
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; see https://szs.wiimm.de/cmd/wkclt/check#desc <span style=color:#66d9ef>for</span> more info.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ ll glf_course_fc1.*
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> redoste redoste 672K 1970-01-01 00:00 glf_course_fc1.kcl
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> redoste redoste  19K 1970-01-01 00:00 glf_course_fc1.mtl
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> redoste redoste 911K 1970-01-01 00:00 glf_course_fc1.obj
</span></span></code></pre></div><p>And of course the opposite is possible</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ wkclt ENC glf_course_fc1.obj
</span></span><span style=display:flex><span>ENCODE KCLTXT:glf_course_fc1.obj -&gt; KCL:./glf_course_fc1.kcl
</span></span><span style=display:flex><span>* CHECK KCLTXT:glf_course_fc1.obj
</span></span><span style=display:flex><span>    - HINT: <span style=color:#ae81ff>1</span> of <span style=color:#ae81ff>8398</span> drivable triangles is face down <span style=color:#f92672>=</span>&gt; --kcl<span style=color:#f92672>=</span>RM-FACEDOWN
</span></span><span style=display:flex><span>    - HINT: <span style=color:#ae81ff>1</span> of <span style=color:#ae81ff>8398</span> drivable triangles is face down <span style=color:#f92672>(</span>&gt;30°<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; No warnings and <span style=color:#ae81ff>2</span> hints <span style=color:#66d9ef>for</span> KCLTXT:glf_course_fc1.obj
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; see https://szs.wiimm.de/cmd/wkclt/check#desc <span style=color:#66d9ef>for</span> more info.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  - create octree: rshift<span style=color:#f92672>=</span>10, n_bcube<span style=color:#f92672>=</span>256, cube_size<span style=color:#f92672>=</span>512..1048576, blow<span style=color:#f92672>=</span>400, max_tri<span style=color:#f92672>=</span>30, max_depth<span style=color:#f92672>=</span>10, fast<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>Here is what <code>glf_course_fc1.obj</code> looks like imported into Blender :
<img src=/img/20200421-wii-sports-modding-1/fc1_imported_in_blender.png alt="glf_course_fc1.obj imported in Blender"></p><p>Since <code>wkclt</code> have been thought for <em>Mario Kart Wii</em> the objects are not correctly named but they correspond to the different kind of ground available in the game (Green, Bunker, etc.) :
<img src=/img/20200421-wii-sports-modding-1/fc1_imported_in_blender_objects_list.png alt="List of objects in Blender"></p><h2 id=2---the-g3dbrres-files>2 - The <code>G3D/*.brres</code> files</h2><p>The <a href=http://wiki.tockdom.com/wiki/BRRES_(File_Format)><code>brres</code> files</a> are some sort of archives that describe a 3D model. This archive is split in sections each one represents a specific part of the object (Model, Texture, Animations&mldr;). Since <code>brres</code> files are common to <em>Mario Kart Wii</em> and <em>Super Smash Bros. Brawl</em>, we can use the <a href=https://github.com/libertyernie/brawltools><em>BrawlBox</em> tool</a>.</p><p><em>BrawlBox</em> is a huge Windows tool that allow easy manipulation of <code>brres</code> archives and its different sections. Because I use GNU/Linux I had to do a little bit of tinkering to run <em>BrawlBox</em> with <em>Wine</em>. Installing <code>dotnet48</code> using <code>winetricks</code> seems to do the job.</p><p>Here is what <code>G3D/glf_course_fc1.brres</code> looks like in BrawlBox :
<img src=/img/20200421-wii-sports-modding-1/fc1_course_brres.png alt="glf_couse_fc1.brres opened in BrawlBox"></p><p>The other <code>brres</code> file: <code>G3D/glf_map_fc1.brres</code> corresponds to the minimap visible in game in the bottom left corner. The map in it self is at the exact same scale as the original, it is only scaled down at the final rendering, making the creation of the map from the original course really easy.</p><p>Here is what <code>G3D/glf_map_fc1.brres</code> looks like in BrawlBox :
<img src=/img/20200421-wii-sports-modding-1/fc1_map_brres.png alt="glf_map_fc1.brres opened in BrawlBox"></p><h2 id=3---the-glf_scene_fc1p-files>3 - The <code>glf_scene_fc1/*.p*</code> files</h2><p>These three files seem to be used to polish the rendering of the map, but I was able to identify only one of them. The <code>plight</code> file seems to match the <a href=http://wiki.tockdom.com/wiki/BLIGHT_(File_Format)>BLIGHT format</a> since its magic number is the same (<code>LGHT</code>). However leaving the folder empty seems to do the trick since the map loads without any problem.</p><h2 id=4---the-glf_course_fc1pmp-file>4 - The <code>glf_course_fc1.pmp</code> file</h2><p>I was unable to clearly identify the format of the <code>pmp</code> file but I think it contains things such as the starting point, the ending point of the course and the position of trees. Its format should be similar to the <a href=http://wiki.tockdom.com/wiki/KMP_(File_Format)>KMP format of <em>Mario Kart Wii</em></a> since it is its purpose.</p><h2 id=5---demo>5 - Demo</h2><p>The first easy demo I can do is making the map flat. For this I converted the KCL file to an OBJ file and set the Y value of every vertices to 0.</p><p>Then I used the scripting feature of BrawlBox to export every objects vertices from the model. The script is based on the builtin one made to export textures.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Script to export or import objects vertices from brres files</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> BrawlBox.API <span style=color:#f92672>import</span> bboxapi
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> BrawlLib.SSBB.ResourceNodes <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>search</span>(node):
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> isinstance(node, MDL0VertexNode):
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> [node]
</span></span><span style=display:flex><span>	list <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> child <span style=color:#f92672>in</span> node<span style=color:#f92672>.</span>Children:
</span></span><span style=display:flex><span>		list <span style=color:#f92672>+=</span> search(child)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> list
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> bboxapi<span style=color:#f92672>.</span>RootNode <span style=color:#f92672>!=</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>	root <span style=color:#f92672>=</span> bboxapi<span style=color:#f92672>.</span>RootNode
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> item <span style=color:#f92672>in</span> search(root):
</span></span><span style=display:flex><span>		print item<span style=color:#f92672>.</span>Name
</span></span><span style=display:flex><span>		<span style=color:#75715e># Use Replace to import and Export to export</span>
</span></span><span style=display:flex><span>		item<span style=color:#f92672>.</span>Export(<span style=color:#e6db74>&#34;C:</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>inp</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>vec</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>+</span> item<span style=color:#f92672>.</span>Name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.vec&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>#item.Replace(&#34;C:\\inp\\vec\\&#34; + item.Name + &#34;.vec&#34;)</span>
</span></span><span style=display:flex><span>	print(<span style=color:#e6db74>&#34;Done!&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>	bboxapi<span style=color:#f92672>.</span>ShowMessage(<span style=color:#e6db74>&#39;Cannot find Root Node (is a file open?)&#39;</span>,<span style=color:#e6db74>&#39;Error&#39;</span>)
</span></span></code></pre></div><p>Then I made a (extremely ugly and unreadable) Python script to flatten the object before reimporting them to the <code>brres</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> struct
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>wo_offset <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wo</span>(b):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>global</span> wo_offset
</span></span><span style=display:flex><span>    wo_offset <span style=color:#f92672>+=</span> len(b)
</span></span><span style=display:flex><span>    sys<span style=color:#f92672>.</span>stderr<span style=color:#f92672>.</span>buffer<span style=color:#f92672>.</span>write(b)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>inf <span style=color:#f92672>=</span> open(sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>], <span style=color:#e6db74>&#34;rb&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>file_length <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#34;&gt;I&#34;</span>, inf<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>4</span>))[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>mdl0_offset <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#34;&gt;I&#34;</span>, inf<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>4</span>))[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>data_offset <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#34;&gt;I&#34;</span>, inf<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>4</span>))[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>name_offset <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#34;&gt;I&#34;</span>, inf<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>4</span>))[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>index       <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#34;&gt;I&#34;</span>, inf<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>4</span>))[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>comp_count  <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#34;&gt;I&#34;</span>, inf<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>4</span>))[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>vec_format  <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#34;&gt;I&#34;</span>, inf<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>4</span>))[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>divisor     <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#34;&gt;B&#34;</span>, inf<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>1</span>))[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>stride      <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#34;&gt;B&#34;</span>, inf<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>1</span>))[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>n_vec       <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#34;&gt;H&#34;</span>, inf<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>2</span>))[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>min_x, min_y, min_z <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#34;&gt;fff&#34;</span>, inf<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>12</span>))
</span></span><span style=display:flex><span>max_x, max_y, max_z <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#34;&gt;fff&#34;</span>, inf<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>12</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Check and write the header</span>
</span></span><span style=display:flex><span>wo(struct<span style=color:#f92672>.</span>pack(<span style=color:#e6db74>&#34;&gt;I&#34;</span>, file_length))
</span></span><span style=display:flex><span>wo(struct<span style=color:#f92672>.</span>pack(<span style=color:#e6db74>&#34;&gt;I&#34;</span>, mdl0_offset))
</span></span><span style=display:flex><span>wo(struct<span style=color:#f92672>.</span>pack(<span style=color:#e6db74>&#34;&gt;I&#34;</span>, data_offset))
</span></span><span style=display:flex><span>wo(struct<span style=color:#f92672>.</span>pack(<span style=color:#e6db74>&#34;&gt;I&#34;</span>, name_offset))
</span></span><span style=display:flex><span>wo(struct<span style=color:#f92672>.</span>pack(<span style=color:#e6db74>&#34;&gt;I&#34;</span>, index))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> comp_count <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0x1</span>:
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;comp_count != 1&#34;</span>)
</span></span><span style=display:flex><span>    sys<span style=color:#f92672>.</span>exit(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>wo(struct<span style=color:#f92672>.</span>pack(<span style=color:#e6db74>&#34;&gt;I&#34;</span>, comp_count))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> vec_format <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0x4</span>:
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;vec_format != 4&#34;</span>)
</span></span><span style=display:flex><span>    sys<span style=color:#f92672>.</span>exit(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>wo(struct<span style=color:#f92672>.</span>pack(<span style=color:#e6db74>&#34;&gt;I&#34;</span>, vec_format))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> divisor <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;divisor != 0&#34;</span>)
</span></span><span style=display:flex><span>    sys<span style=color:#f92672>.</span>exit(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>wo(struct<span style=color:#f92672>.</span>pack(<span style=color:#e6db74>&#34;&gt;B&#34;</span>, divisor))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> stride <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0xc</span>:
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;stride != 0xc&#34;</span>)
</span></span><span style=display:flex><span>    sys<span style=color:#f92672>.</span>exit(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>wo(struct<span style=color:#f92672>.</span>pack(<span style=color:#e6db74>&#34;&gt;B&#34;</span>, stride))
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;n_vec = </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span>format(n_vec))
</span></span><span style=display:flex><span>wo(struct<span style=color:#f92672>.</span>pack(<span style=color:#e6db74>&#34;&gt;H&#34;</span>, n_vec))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;min = </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>,</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>,</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span>format(min_x, min_y, min_z))
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;max = </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>,</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>,</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span>format(max_x, max_y, max_z))
</span></span><span style=display:flex><span>min_y <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>max_y <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;min = </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>,</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>,</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span>format(min_x, min_y, min_z))
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;max = </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>,</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>,</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span>format(max_x, max_y, max_z))
</span></span><span style=display:flex><span>wo(struct<span style=color:#f92672>.</span>pack(<span style=color:#e6db74>&#34;&gt;fff&#34;</span>, min_x, min_y, min_z))
</span></span><span style=display:flex><span>wo(struct<span style=color:#f92672>.</span>pack(<span style=color:#e6db74>&#34;&gt;fff&#34;</span>, max_x, max_y, max_z))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> _ <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>8</span>):
</span></span><span style=display:flex><span>    wo(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>inf<span style=color:#f92672>.</span>seek(data_offset)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> n <span style=color:#f92672>in</span> range(n_vec):
</span></span><span style=display:flex><span>    x, y, z <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#34;&gt;fff&#34;</span>, inf<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>12</span>))
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;n = </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> : </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>,</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>,</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span>format(n, x, y, z))
</span></span><span style=display:flex><span>    y <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    wo(struct<span style=color:#f92672>.</span>pack(<span style=color:#e6db74>&#34;&gt;fff&#34;</span>, x, y, z))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> _ <span style=color:#f92672>in</span> range(file_length <span style=color:#f92672>-</span> wo_offset):
</span></span><span style=display:flex><span>    wo(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sys<span style=color:#f92672>.</span>stderr<span style=color:#f92672>.</span>buffer<span style=color:#f92672>.</span>flush()
</span></span></code></pre></div><p>After packing everything back up, we can rebuild the game image and admire this amazing flat golf course with flying trees, starting point and ending point !</p><p><img src=/img/20200421-wii-sports-modding-1/fc1_flat_screenshot_1.png alt="Screenshot of the first golf course but flat 1">
<img src=/img/20200421-wii-sports-modding-1/fc1_flat_screenshot_2.png alt="Screenshot of the first golf course but flat 2"></p><h1 id=ii---reverse-engineering-the-binary>II - Reverse-engineering the binary</h1><p>The main game binary is in the <a href=https://wiibrew.org/wiki/DOL>DOL format</a>, it&rsquo;s a pretty simple format and was able to open it in Ghidra pretty easily. I&rsquo;m far from being skilled enough to completely reverse-engineer the binary but using simple string searches and X-refs I was able to identify important functions : reading files, reading archives, loading maps and I think I even identified the one responsible of parsing the unknown <code>pmp</code> file.</p><p>Here is the list of function identified (for the second European version I own : <code>sha1sum main.dol : 0328a87d999995f95592f91c8d948d9995bb06bd</code>)</p><ul><li><code>crash</code> : <code>0x8010ab58</code></li><li><code>get_lang_code</code> : <code>0x80186410</code></li><li><code>golf_get_fc_string</code> : <code>0x8029db44</code></li><li><code>golf_load_kcl_pmp</code> : <code>0x80293d5c</code></li><li><code>golf_load_stage_common_carc</code> : <code>0x8028eb84</code></li><li><code>golf_process_kcl?</code> : <code>0x802a7414</code></li><li><code>golf_process_pmp?</code> : <code>0x801bf824</code></li><li><code>golf_process_pmp?2</code> : <code>0x801bf890</code></li><li><code>heap_alloc</code> : <code>0x800a2e38</code></li><li><code>heap_alloc_wraper</code> : <code>0x800a3250</code></li><li><code>load_from_carc</code> : <code>0x80187a44</code></li><li><code>load_from_carc_in_filelist</code> : <code>0x8028eb68</code></li><li><code>load_locales</code> : <code>0x801877d0</code></li><li><code>print_serial</code> : <code>0x801840dc</code></li><li><code>sprintf</code> : <code>0x802aaf00</code></li><li><code>strcat</code> : <code>0x800b8e40</code></li></ul><p>What made the process really hard and sometimes impossible for me is that I don&rsquo;t know a lot PowerPC assembly so I generally blindly trusted Ghidra decompiler and only looked at the manual when required but most importantly this is C++ code, so we have to deal with all the C++ annoying stuff. To make this thing even more hard, Nintendo should use some weird custom compiler because it uses <code>r13</code> to store the <code>this</code> pointer instead of using the first function argument like any other compilers but most importantly <code>r13</code> point to the <strong>end</strong> of the structure ! Ghidra doesn&rsquo;t seem to support looking at structure from the end and having to subtract offsets from the pointer so it just decompiles it to unreadable garbage pointer arithmetic.</p><p>Here is my favorite one (from <code>golf_get_fc_string</code>) :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>return</span> (<span style=color:#f92672>&amp;</span>PTR_s_fc1_803e1fe0)[<span style=color:#f92672>*</span>(<span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>)(<span style=color:#f92672>*</span>(<span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>)((<span style=color:#66d9ef>int</span>)local_r13_<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>0x5abc</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x98</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>9</span>];
</span></span></code></pre></div><hr><p><strong>Edit : 2020-04-22 23:20 +0200 :</strong> <a href=https://www.reddit.com/r/WiiHacks/comments/g5nl9j/just_finished_to_write_my_first_blog_post_on_wii/fo5up0d>u/Leseratte10 mentioned on reddit</a> that <code>r13</code> is used for the <em>Small Data Area</em>. Because PowerPC is a <a href=https://en.wikipedia.org/wiki/Reduced_instruction_set_computer>RISC</a> architecture there is a really small number of instructions, something as simple as accessing a global variable can take 2 instructions. To compensate, the compiler put all frequently accessed globals in this <em>Small Data Area</em> (here it is 64KiB large) and makes <code>r13</code> constant by initialising it in the entry point function. Now globals in the <em>Small Data Area</em> can be accessed with only one instruction.</p><p>This problem was already discussed in a <a href=https://github.com/NationalSecurityAgency/ghidra/issues/325>Ghidra Github issue</a>. After installing a <a href=https://github.com/aldelaro5/ghidra-gekko-broadway-lang>custom language definition for the <em>Gekko</em> and <em>Broadway</em> CPUs</a> and reanalysing the whole binary, the <code>r13</code> register is now considered constant. Using the <em>Register Manager</em> of Ghidra, we can set the value of <code>r13</code> (here it is <code>0x804df900</code>) and now decompilation makes way more sense.</p><p>Here is the previous snippet of <code>golf_get_fc_string</code> correctly decompiled :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>return</span> (<span style=color:#f92672>&amp;</span>PTR_DAT_803e1fe0)[<span style=color:#f92672>*</span>(<span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>)(DAT_804d9e44 <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x98</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>9</span>];
</span></span></code></pre></div><p>The <code>this</code> pointer is correctly passed as the first argument of functions (via <code>r3</code>).</p><hr><p>To finish this part on a positive note, some of the code is shared with <em>Mario Kart Wii</em> (yes, again) so here is this amazing decompilation project of <em>Mario Kart Wii</em> by <em>riidefi</em> that helped me a lot : <a href=https://github.com/riidefi/MKWDecompilation>https://github.com/riidefi/MKWDecompilation</a></p><h1 id=iii---adding-a-custom-debug-output>III - Adding a custom debug output</h1><p>While working on custom maps, the game crashed, a lot. So to understand why it crashed I generally enabled the Dolphin debugger and followed the backtrace, looking at what functions it corresponds in Ghidra. A lot of this crashes where due to failed <code>assert</code>s and the <code>assert</code>s called <code>print_serial</code> before calling <code>crash</code>. This <code>print_serial</code> just seems to backup some registers to locals before returning. I think they removed the debug output in the final release.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#a6e22e>print_serial</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stwu</span>       <span style=color:#66d9ef>r1</span>,<span style=color:#66d9ef>local_70</span>(<span style=color:#66d9ef>r1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bne</span>        <span style=color:#66d9ef>cr1</span>,<span style=color:#66d9ef>LAB_80184104</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stfd</span>       <span style=color:#66d9ef>f1</span>,<span style=color:#66d9ef>local_48</span>(<span style=color:#66d9ef>r1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stfd</span>       <span style=color:#66d9ef>f2</span>,<span style=color:#66d9ef>local_40</span>(<span style=color:#66d9ef>r1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stfd</span>       <span style=color:#66d9ef>f3</span>,<span style=color:#66d9ef>local_38</span>(<span style=color:#66d9ef>r1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stfd</span>       <span style=color:#66d9ef>f4</span>,<span style=color:#66d9ef>local_30</span>(<span style=color:#66d9ef>r1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stfd</span>       <span style=color:#66d9ef>f5</span>,<span style=color:#66d9ef>local_28</span>(<span style=color:#66d9ef>r1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stfd</span>       <span style=color:#66d9ef>f6</span>,<span style=color:#66d9ef>local_20</span>(<span style=color:#66d9ef>r1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stfd</span>       <span style=color:#66d9ef>f7</span>,<span style=color:#66d9ef>local_18</span>(<span style=color:#66d9ef>r1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stfd</span>       <span style=color:#66d9ef>f8</span>,<span style=color:#66d9ef>local_10</span>(<span style=color:#66d9ef>r1</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>LAB_80184104</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stw</span>        <span style=color:#66d9ef>r3</span>,<span style=color:#66d9ef>local_68</span>(<span style=color:#66d9ef>r1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stw</span>        <span style=color:#66d9ef>r4</span>,<span style=color:#66d9ef>local_64</span>(<span style=color:#66d9ef>r1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stw</span>        <span style=color:#66d9ef>r5</span>,<span style=color:#66d9ef>local_60</span>(<span style=color:#66d9ef>r1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stw</span>        <span style=color:#66d9ef>r6</span>,<span style=color:#66d9ef>local_5c</span>(<span style=color:#66d9ef>r1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stw</span>        <span style=color:#66d9ef>r7</span>,<span style=color:#66d9ef>local_58</span>(<span style=color:#66d9ef>r1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stw</span>        <span style=color:#66d9ef>r8</span>,<span style=color:#66d9ef>local_54</span>(<span style=color:#66d9ef>r1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stw</span>        <span style=color:#66d9ef>r9</span>,<span style=color:#66d9ef>local_50</span>(<span style=color:#66d9ef>r1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stw</span>        <span style=color:#66d9ef>r10</span>,<span style=color:#66d9ef>local_4c</span>(<span style=color:#66d9ef>r1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>addi</span>       <span style=color:#66d9ef>r1</span>,<span style=color:#66d9ef>r1</span>,<span style=color:#ae81ff>0x70</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>blr</span>
</span></span></code></pre></div><p>To get this debug output working I didn&rsquo;t want to patch the binary since I don&rsquo;t know how to easily output the strings so I just modified the code of the emulator instead !</p><p>Since <a href=https://github.com/dolphin-emu/dolphin>Dolphin is open source</a>, it was really easy. I edited the code of the branch instruction to print strings when the destination address is the one of <code>print_serial</code>. Because <code>print_serial</code> should behave like <code>printf</code> and that the memory of the emulated console is only available via functions emulating the memory bus, the easiest thing to do was to create a simple and incomplete <code>printf</code> implementation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// In Source/Core/Core/PowerPC/Interpreter/Interpreter_Branch.cpp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> Interpreter<span style=color:#f92672>::</span><span style=color:#a6e22e>bx</span>(UGeckoInstruction inst)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (inst.LK)
</span></span><span style=display:flex><span>    LR <span style=color:#f92672>=</span> PC <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (inst.AA)
</span></span><span style=display:flex><span>    NPC <span style=color:#f92672>=</span> <span style=color:#a6e22e>SignExt26</span>(inst.LI <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    NPC <span style=color:#f92672>=</span> PC <span style=color:#f92672>+</span> <span style=color:#a6e22e>SignExt26</span>(inst.LI <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Here is my incomplete ugly printf implementation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (NPC <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x801840dc</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span> gpr3 <span style=color:#f92672>=</span> PowerPC<span style=color:#f92672>::</span>ppcState.gpr[<span style=color:#ae81ff>3</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> r <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> c, t;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>do</span> {
</span></span><span style=display:flex><span>      c <span style=color:#f92672>=</span> PowerPC<span style=color:#f92672>::</span><span style=color:#a6e22e>Read_U8</span>(gpr3);
</span></span><span style=display:flex><span>      gpr3<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span>(c <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;%&#39;</span>){
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>putc</span>(c, stdout);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      t <span style=color:#f92672>=</span> PowerPC<span style=color:#f92672>::</span><span style=color:#a6e22e>Read_U8</span>(gpr3);
</span></span><span style=display:flex><span>      gpr3<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span>(t <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;s&#39;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>uint32_t</span> ptr <span style=color:#f92672>=</span> PowerPC<span style=color:#f92672>::</span>ppcState.gpr[r];
</span></span><span style=display:flex><span>        r<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>char</span> cBis;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>do</span> {
</span></span><span style=display:flex><span>          cBis <span style=color:#f92672>=</span> PowerPC<span style=color:#f92672>::</span><span style=color:#a6e22e>Read_U8</span>(ptr);
</span></span><span style=display:flex><span>          ptr<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>putc</span>(cBis, stdout);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>while</span> (cBis <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (t <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;%&#39;</span>){
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>putc</span>(<span style=color:#e6db74>&#39;%&#39;</span>, stdout);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (t <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;0&#39;</span>){
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Padded format strings : &#34;%08x&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>char</span> formatStr[] <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;%&#39;</span>, t, PowerPC<span style=color:#f92672>::</span><span style=color:#a6e22e>Read_U8</span>(gpr3), PowerPC<span style=color:#f92672>::</span><span style=color:#a6e22e>Read_U8</span>(gpr3<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)};
</span></span><span style=display:flex><span>        gpr3 <span style=color:#f92672>+=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(formatStr, PowerPC<span style=color:#f92672>::</span>ppcState.gpr[r]);
</span></span><span style=display:flex><span>        r<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>char</span> formatStr[] <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;%&#39;</span>, t};
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(formatStr, PowerPC<span style=color:#f92672>::</span>ppcState.gpr[r]);
</span></span><span style=display:flex><span>        r<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>while</span>(c <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  m_end_block <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Because I edited the PowerPC interpreter, I had to disable the JIT but the Wii is a pretty modern console, my 7-year-old Intel CPU was pretty slow while trying to interpret the 729 Mhz PowerPC CPU of the Wii. It was unusable. I was not confident while trying to understand the JIT code so I just added a line to disable JIT on branch instruction to <code>print_serial</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// In Source/Core/Core/PowerPC/Jit64/Jit_Branch.cpp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> Jit64<span style=color:#f92672>::</span><span style=color:#a6e22e>bx</span>(UGeckoInstruction inst)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>FALLBACK_IF</span>(js.op<span style=color:#f92672>-&gt;</span>branchTo <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x801840dc</span>);
</span></span><span style=display:flex><span>  <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>There are some slowdowns when the game tries to print a lot of stuff but at least it works !</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-markdown data-lang=markdown><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span>&lt; <span style=color:#f92672>RVL_SDK</span> <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>EXI</span> 	<span style=color:#a6e22e>release</span> <span style=color:#a6e22e>build:</span> <span style=color:#a6e22e>Nov</span> <span style=color:#a6e22e>30</span> <span style=color:#a6e22e>2006</span> <span style=color:#a6e22e>03:26:56</span> <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>0x4199_60831</span><span style=color:#960050;background-color:#1e0010>)</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span>&lt; <span style=color:#f92672>RVL_SDK</span> <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>SI</span> 	<span style=color:#a6e22e>release</span> <span style=color:#a6e22e>build:</span> <span style=color:#a6e22e>Nov</span> <span style=color:#a6e22e>30</span> <span style=color:#a6e22e>2006</span> <span style=color:#a6e22e>03:31:44</span> <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>0x4199_60831</span><span style=color:#960050;background-color:#1e0010>)</span> &gt;&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Revolution OS
</span></span><span style=display:flex><span>Kernel built : Apr 24 2007 11:50:47
</span></span><span style=display:flex><span>Console Type : NDEV 2.1
</span></span><span style=display:flex><span>Firmware     : 21.4.15 (3/3/2010)
</span></span><span style=display:flex><span>Memory 88 MB
</span></span><span style=display:flex><span>MEM1 Arena : 0x804f0fa0 - 0x817fcda0
</span></span><span style=display:flex><span>MEM2 Arena : 0x90000800 - 0x933e0000
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span>&lt; <span style=color:#f92672>RVL_SDK</span> <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>OS</span> 	<span style=color:#a6e22e>release</span> <span style=color:#a6e22e>build:</span> <span style=color:#a6e22e>Apr</span> <span style=color:#a6e22e>24</span> <span style=color:#a6e22e>2007</span> <span style=color:#a6e22e>11:50:47</span> <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>0x4199_60831</span><span style=color:#960050;background-color:#1e0010>)</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span>&lt; <span style=color:#f92672>RVL_SDK</span> <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>SC</span> 	<span style=color:#a6e22e>release</span> <span style=color:#a6e22e>build:</span> <span style=color:#a6e22e>Nov</span> <span style=color:#a6e22e>30</span> <span style=color:#a6e22e>2006</span> <span style=color:#a6e22e>03:33:00</span> <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>0x4199_60831</span><span style=color:#960050;background-color:#1e0010>)</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span>&lt; <span style=color:#f92672>RVL_SDK</span> <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>NAND</span> 	<span style=color:#a6e22e>release</span> <span style=color:#a6e22e>build:</span> <span style=color:#a6e22e>Nov</span> <span style=color:#a6e22e>30</span> <span style=color:#a6e22e>2006</span> <span style=color:#a6e22e>03:32:57</span> <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>0x4199_60831</span><span style=color:#960050;background-color:#1e0010>)</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span>&lt; <span style=color:#f92672>RVL_SDK</span> <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>NWC24</span> 	<span style=color:#a6e22e>release</span> <span style=color:#a6e22e>build:</span> <span style=color:#a6e22e>May</span> <span style=color:#a6e22e>10</span> <span style=color:#a6e22e>2007</span> <span style=color:#a6e22e>17:58:59</span> <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>0x4199_60831</span><span style=color:#960050;background-color:#1e0010>)</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span>&lt; <span style=color:#f92672>RVL_SDK</span> <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>DVD</span> 	<span style=color:#a6e22e>release</span> <span style=color:#a6e22e>build:</span> <span style=color:#a6e22e>Apr</span> <span style=color:#a6e22e>24</span> <span style=color:#a6e22e>2007</span> <span style=color:#a6e22e>11:44:29</span> <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>0x4199_60831</span><span style=color:#960050;background-color:#1e0010>)</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span>&lt; <span style=color:#f92672>NW4R</span>    <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>EF</span> 	<span style=color:#a6e22e>final</span>   <span style=color:#a6e22e>build:</span> <span style=color:#a6e22e>Jun</span>  <span style=color:#a6e22e>8</span> <span style=color:#a6e22e>2007</span> <span style=color:#a6e22e>11:16:29</span> <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>0x4199_60831</span><span style=color:#960050;background-color:#1e0010>)</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span>&lt; <span style=color:#f92672>RVL_SDK</span> <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>GX</span> 	<span style=color:#a6e22e>release</span> <span style=color:#a6e22e>build:</span> <span style=color:#a6e22e>Nov</span> <span style=color:#a6e22e>30</span> <span style=color:#a6e22e>2006</span> <span style=color:#a6e22e>03:30:39</span> <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>0x4199_60831</span><span style=color:#960050;background-color:#1e0010>)</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span>&lt; <span style=color:#f92672>RVL_SDK</span> <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>VI</span> 	<span style=color:#a6e22e>release</span> <span style=color:#a6e22e>build:</span> <span style=color:#a6e22e>Nov</span> <span style=color:#a6e22e>30</span> <span style=color:#a6e22e>2006</span> <span style=color:#a6e22e>03:31:49</span> <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>0x4199_60831</span><span style=color:#960050;background-color:#1e0010>)</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span>&lt; <span style=color:#f92672>RVL_SDK</span> <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>WPAD</span> 	<span style=color:#a6e22e>release</span> <span style=color:#a6e22e>build:</span> <span style=color:#a6e22e>May</span> <span style=color:#a6e22e>17</span> <span style=color:#a6e22e>2007</span> <span style=color:#a6e22e>01:52:03</span> <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>0x4199_60831</span><span style=color:#960050;background-color:#1e0010>)</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span>&lt; <span style=color:#f92672>RVL_SDK</span> <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>KPAD</span> 	<span style=color:#a6e22e>release</span> <span style=color:#a6e22e>build:</span> <span style=color:#a6e22e>Jun</span>  <span style=color:#a6e22e>5</span> <span style=color:#a6e22e>2007</span> <span style=color:#a6e22e>11:27:45</span> <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>0x4199_60831</span><span style=color:#960050;background-color:#1e0010>)</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span>&lt; <span style=color:#f92672>NW4R</span>    <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>G3D</span> 	<span style=color:#a6e22e>final</span>   <span style=color:#a6e22e>build:</span> <span style=color:#a6e22e>Jun</span>  <span style=color:#a6e22e>8</span> <span style=color:#a6e22e>2007</span> <span style=color:#a6e22e>11:16:25</span> <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>0x4199_60831</span><span style=color:#960050;background-color:#1e0010>)</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span>&lt; <span style=color:#f92672>NW4R</span>    <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>LYT</span> 	<span style=color:#a6e22e>final</span>   <span style=color:#a6e22e>build:</span> <span style=color:#a6e22e>Jun</span>  <span style=color:#a6e22e>8</span> <span style=color:#a6e22e>2007</span> <span style=color:#a6e22e>11:17:26</span> <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>0x4199_60831</span><span style=color:#960050;background-color:#1e0010>)</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span>&lt; <span style=color:#f92672>RVL_SDK</span> <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>AI</span> 	<span style=color:#a6e22e>release</span> <span style=color:#a6e22e>build:</span> <span style=color:#a6e22e>Nov</span> <span style=color:#a6e22e>30</span> <span style=color:#a6e22e>2006</span> <span style=color:#a6e22e>03:26:11</span> <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>0x4199_60831</span><span style=color:#960050;background-color:#1e0010>)</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span>&lt; <span style=color:#f92672>RVL_SDK</span> <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>AX</span> 	<span style=color:#a6e22e>release</span> <span style=color:#a6e22e>build:</span> <span style=color:#a6e22e>Dec</span> <span style=color:#a6e22e>18</span> <span style=color:#a6e22e>2006</span> <span style=color:#a6e22e>15:43:48</span> <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>0x4199_60831</span><span style=color:#960050;background-color:#1e0010>)</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span>&lt; <span style=color:#f92672>RVL_SDK</span> <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>DSP</span> 	<span style=color:#a6e22e>release</span> <span style=color:#a6e22e>build:</span> <span style=color:#a6e22e>Nov</span> <span style=color:#a6e22e>30</span> <span style=color:#a6e22e>2006</span> <span style=color:#a6e22e>03:26:46</span> <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>0x4199_60831</span><span style=color:#960050;background-color:#1e0010>)</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span>&lt; <span style=color:#f92672>NW4R</span>    <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>SND</span> 	<span style=color:#a6e22e>final</span>   <span style=color:#a6e22e>build:</span> <span style=color:#a6e22e>Jun</span>  <span style=color:#a6e22e>8</span> <span style=color:#a6e22e>2007</span> <span style=color:#a6e22e>11:17:15</span> <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>0x4199_60831</span><span style=color:#960050;background-color:#1e0010>)</span> &gt;&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span>&lt; <span style=color:#f92672>RVL_SDK</span> <span style=color:#a6e22e>-</span> <span style=color:#a6e22e>RFL</span> 	<span style=color:#a6e22e>release</span> <span style=color:#a6e22e>build:</span> <span style=color:#a6e22e>Jun</span>  <span style=color:#a6e22e>9</span> <span style=color:#a6e22e>2007</span> <span style=color:#a6e22e>17:25:33</span> <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>0x4199_60831</span><span style=color:#960050;background-color:#1e0010>)</span> &gt;&gt;
</span></span><span style=display:flex><span>eggAudioArcPlayerMgr:Sound Archive is already opened
</span></span></code></pre></div><h1 id=iv---conclusion>IV - Conclusion</h1><p>This blog post summarize how far I have been able to mod <em>Wii Sports</em>, I hope it will be useful to someone else but a least it useful for me to note my progress and maybe, one day, later, try to do something more complete.</p><h1 id=comments->Comments :</h1><p><strong><a href=https://www.reddit.com/user/reDOSte/comments/g5gcao/modding_wii_sports_part_i_identifying_files_and/>Reddit</a> or <a href=https://twitter.com/redoste/status/1252606484770435072>Twitter</a></strong></p></main><hr><footer>© 2020 - 2025 redoste - <a href=https://creativecommons.org/licenses/by/4.0/>CC-BY-4.0</a></footer></body></html>